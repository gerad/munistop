<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MuniStop</title>
  <style type="text/css" media="screen">@import "/css/jqtouch.min.css";</style>
  <style type="text/css" media="screen">@import "/css/apple.min.css";</style>
  <script src="/js/jquery-1.4.1.js" type="text/javascript" charset="utf-8"></script>
  <script src="/js/jqtouch.js" type="application/x-javascript" charset="utf-8"></script>
  <style>
  #times table {
    border-collapse: collapse;
    width: 100%;
    color: black;
  }
  #times td {
    padding: 5px;
  }
  #times td.route-stop {
    text-align: left;
    padding-right: 10px;
  }
  #times td.times {
    text-align: center;
    width: 60px;
  }
  #times div.stop, div.current {
    font-weight: bold;
    font-size: 22px;
  }
  #times div.route, div.next {
    font-size: 10px;
    color: gray;
  }
  #refresh > div {
    width:20px;
  }
  #refresh div.refresh {
    background: url(/i/refresh.png) no-repeat 0px 3px;
  }

  @-webkit-keyframes rotate {
    0% { -webkit-transform: rotate(0deg); }
    25% { -webkit-transform: rotate(90deg); }
    50% { -webkit-transform: rotate(180deg); }
    75% { -webkit-transform: rotate(270deg); }
    100% { -webkit-transform: rotate(360deg); }
  }

  #refresh div.refreshing {
    background: url(/i/refreshing.png) no-repeat 0px 6px;
    -webkit-animation: rotate 2s linear infinite;
    display: none;
  }

  .disabled { color :red; }

  .slideback.in { -webkit-animation-name: slideinfromleft; }
  .slideback.out { -webkit-animation-name: slideouttoright; }
  .slideback.in.reverse { -webkit-animation-name: slideinfromright; }
  .slideback.out.reverse { -webkit-animation-name: slideouttoleft; }
  </style>
</head>
<body>
  <div id="home">
      <div class="toolbar">
          <h1>MuniStop</h1>
          <div id="refresh" class="button">
            <div class="refresh">&nbsp;</div>
            <div class="refreshing">&nbsp;</div>
          </div>
      </div>
      <ul id="times" class="metal"></ul>

      <a href="#choice" id="add" style="margin: 10px;" class="whiteButton slideup">Add Stop</a>
  </div>

  <div id="choice">
    <div class="toolbar">
      <h1>Add Stop</h1>
      <a href="#home" class="cancel">Cancel</a>
    </div>

    <ul id="choices" class="rounded">
      <li class="arrow"><a href="#route">Choose a route</a></li>
      <li class="arrow"><a href="#direction" class="disabled">Choose a direction</a></li>
      <li class="arrow"><a href="#stop" class="disabled">Choose a stop</a></li>
    </ul>

    <a href="#home" style="margin: 10px;" class="whiteButton disabled">Add Stop</a>
  </div>

  <div id="route">
    <div class="toolbar">
        <h1>Choose Route</h1>
        <a href="#add" class="cancel">Cancel</a>
    </div>

    <ul id="routes" class="rounded">
      <li>Loading&hellip;</li>
    </ul>
  </div>

  <div id="direction">
    <div class="toolbar">
        <h1>Choose Direction</h1>
        <a href="#add" class="cancel">Cancel</a>
    </div>

    <ul id="directions" class="rounded">
      <li>Loading&hellip;</li>
    </ul>
  </div>

  <div id="stop">
    <div class="toolbar">
        <h1>Choose Stop</h1>
        <a href="#add" class="cancel">Cancel</a>
    </div>

    <ul id="stops" class="rounded">
      <li>Loading&hellip;</li>
    </ul>
  </div>

</body>
<script>
var jQT = $.jQTouch({
  startupScreen: 'i/loading.gif'
});

$(function() {
  jQT.addAnimation({
    name: 'slideback',
    selector: '.slideback'
  });

  /* model */
  var model = new function() {
    this.routes = function routes() {
      return new RemoteData('/routes');
    };

    this.directions = function directions(route) {
      return new RemoteData('/routes/' + route.id + '/directions');
    };

    this.stops = function stops(route, direction) {
      return new RemoteData('/routes/' + route.id + '/directions/' + direction.id + '/stops');
    };


    function RemoteData(url) {
      var data, callbacks = [];

      $.getJSON(url, function(json) {
        data = json.map(function(options) { return { id: options[1], name: options[0] } });
        runCallbacks();
      });

      this.forEach = function forEach(callback, options) {
        options = options || {};
        addCallback(function(data) {
          if ('first' in options) options.first();
          data.forEach(callback);
        });
      };

      function addCallback(callback) {
        callbacks.push(callback);
        runCallbacks();
      }

      function runCallbacks() {
        if (data === undefined) return;
        var callback;
        while (callback = callbacks.pop()) callback(data);
      }
    };
  };

  /* view */
  var view = new function() {
    var self = this, _ = {};

    /* add button */
    this.add = {};
    observable(this.add, 'click').watch('#add');

    /* choice */
    this.choice = function choice(opts) {
      opts = opts || {};
      var shouldDisable = false;
      'route direction stop'.split(' ').forEach(function(c) {
        var a = $('#choices a[href=#' + c + ']');

        if (shouldDisable)
          a.addClass('disabled')
        else
          a.removeClass('disabled');

        if (!(c in opts)) shouldDisable = true;
        a.html(shouldDisable ? 'Choose a ' + c : opts[c].name);
      });
      if (shouldDisable) $('#choice .whiteButton').addClass('disabled');
      else $('#choice .whiteButton').removeClass('disabled');
    };
    $('#choice .whiteButton, #choices a').click(function() {
      return !$(this).hasClass('disabled'); // ignore clicks on disabled
    });

    /* refresh button */
    this.refreshing = function refreshing(on) {
      if (typeof on !== 'boolean')
        on = !$('#refresh').data('refreshing');
      $('#refresh').data('refreshing', on);

      $('#refresh div.refresh' + (on ? '' : 'ing')).hide();
      $('#refresh div.refresh' + (on ? 'ing' : '')).show();

      return on;
    };
    $('#refresh').data('refreshing', false);
    observable(this.refreshing, 'click').watch('#refresh').click(this.refreshing);

    /* routes */
    this.routes = function routes(data) {
      loadOptions('#routes', data, routes);
    }
    observable(this.routes, 'click');

    /* directions */
    this.directions = function directions(data) {
      loadOptions('#directions', data, directions);
    }
    observable(this.directions, 'click');

    /* stops */
    this.stops = function stops(data) {
      loadOptions('#stops', data, stops);
    }
    observable(this.stops, 'click');


    function loadOptions(ul, options, observer) {
      options.forEach(function(option) {
        var li = $(['<li><a href="#choice" class="slideback">',option.name,'</a></li>'].join(''));
        li.appendTo(ul);
        li.data(option);
        observer.watch(li)
      }, { first: function() { $(ul).empty(); } });
    }

    // make a view item observable
    function observable(fn, methods) {
      methods = methods.split(/\s+/);
      var callbacks = {};

      fn.observe = function observe(method, callback) {
        if (!(method in callbacks)) callbacks[method] = [];
        callbacks[method].push(callback);
      };

      methods.forEach(function(method) {
        fn[method] = function(callback) {
          fn.observe(method, callback);
        };
      });

      fn.watch = function watch(sel) {
        sel = $(sel);
        methods.forEach(function(method) {
          sel[method](function() { notify(method, sel.data()); });
        });
        return fn;
      };

      function notify(method, data) {
        if (!(method in callbacks)) return;
        callbacks[method].forEach(function(callback) {
          callback(data);
        });
      }

      return fn;
    }
  };

  /* controller */
  var controller = new function() {
    var self = this, choice = {};

    view.add.click(function() {
      view.routes(model.routes());
    });

    view.routes.click(function(route) {
      choice.route = route;
      if ('direction' in choice) delete choice.direction;
      if ('stop' in choice) delete choice.stop;
      view.choice(choice);
      view.directions(model.directions(route));
    });

    view.directions.click(function(direction) {
      choice.direction = direction;
      if ('stop' in choice) delete choice.stop;
      view.choice(choice);
      view.stops(model.stops(choice.route, choice.direction));
    });

    view.stops.click(function(stop) {
      choice.stop = stop;
      view.choice(choice);
    });

  }
});
</script>
</html>
