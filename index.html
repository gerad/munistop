<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>munistop</title>
  <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"/>
  <meta name="apple-touch-fullscreen" content="YES" />
  <link rel="icon" type="image/vnd.microsoft.icon" href="/images/favicon.ico" />
  <style>
    body {
      margin:0;
      font-family: Helvetica, Arial, Sans-Serif;
    }
    body[orient=portrait] {
      min-height: 356px;
      width: 320px;
    }
    body[orient=landscape] {
      min-height: 320px;
      width: 356px;
    }
    h1 {
      text-align:center;
      font-size:10px;
      padding: 2px;
      margin:0px 0px 2px 0px;
      background-color: black;
      color:white;
    }
    form {
      clear: both;
    }
    select {
      display: block;
      width: 100%;
      font-size: 20px;
    }
    #times table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 10px;
    }
    #times td {
      padding: 5px;
    }
    #times td.info {
      text-align: left;
      padding-right: 10px;
    }
    #times td.times {
      text-align: center;
      width: 60px;
    }
    #times div.stop, div.current {
      font-weight: bold;
      font-size: 18px;
    }
    #times div.route, div.next {
      font-size: 10px;
      color: gray;
    }
  </style>
  <script src="http://www.google.com/jsapi"></script>
  <script>
    google.load("jquery", "1");
    google.setOnLoadCallback(function() {
      $(function() {

        ////////// db
        var cookies = 10;
        var stringify = function(selects) {
          var ret = '';
          selects.each(function() {
            ret += $(this).val() + "\t" + $(this).find(':selected').text() + "\n";
          });
          return ret;
        };

        var unstringify = function(string) {
          var ret = [];
          $.each(string.split("\n"), function(i, row) {
            if(row) ret.push(row.split("\t"));
          });
          return ret;
        };

        var cookie = function(c_name, value, expiredays) {
          c_name = '' + c_name;
          if(value) { // set the cookie
            var exdate = new Date();
            exdate.setDate(exdate.getDate() + expiredays);
            document.cookie = c_name + "=" + escape(value) +
              ((expiredays == null) ? "" : ";expires="+exdate.toGMTString());
          } else { // get the cookie
            if (document.cookie.length <= 0) return null;

            c_start = document.cookie.indexOf(c_name + "=");
            if (c_start == -1) return null;
            c_start = c_start + c_name.length + 1; 

            c_end = document.cookie.indexOf(";",c_start);
            if (c_end == -1) c_end = document.cookie.length;

            return unescape(document.cookie.substring(c_start, c_end));
          }
        };

        var save = function(selects) {
          for(var i = cookies - 2; i >= 0; i--) {
            var c = cookie(i);
            if(c) cookie(i + 1, c, 90);
          }
          cookie(0, stringify(selects), 90);
        }

        ////////// api
        var hierarchy = ['routes', 'directions', 'stops', 'times'];
        var posf = function(name) {
          return $.inArray(name, hierarchy);
        };

        var url = function(data) {
          var url = '';
          for(var i = 0; i <= data.length; i++) {
            if(i > 0) url += '/' + data[i - 1];
            url += '/' + hierarchy[i];
          }
          return url;
        };

        var get = function(name, callback) {
          var pos = posf(name);
          var data = []
          selects.slice(0, pos).map(function() { data.push($(this).val()); });
          var u = url(data);
          $.getJSON(u, callback);
        }

        ////////// choice
        var selects = $('select');

        var reset = function(select) {
          var opt1 = select.children().eq(0);
          select.children().remove();
          select.append(opt1);
          select.attr({ disabled: true });
        }

        var update = function(name) {
          var pos = posf(name);

          for(var i = pos; i < hierarchy.length; i++)
            reset(selects.eq(i));

          get(name, function(data) {
            var select = selects.eq(pos);
            select.attr({ disabled: false });

            $.each(data, function(i, a) {
              $('<option></option')
                .attr({ value: a[1] })
                .html(a[0])
                .appendTo(select);
            });
          });
        };

        selects.change(function() {
          var name = $(this).attr('name');
          var pos = posf(name);
          var next = hierarchy[pos + 1];
          if(next != 'times') update(next);
          else time();
        });

        update('routes');

        ////////// time
        var display = function(data) {
          var table = $("<table><tr>" +
            "<td class='info'>" +
            "  <div class='stop'>" + data[2][1] + '</div>' +
            "  <div class='route'>" + data[0][1] + ' - ' + data[1][1] + '</div>' +
            "</td><td class='times'>" +
            "  <img class='loading' src='/images/ajax-loader.gif' alt='loading&hellip;' />" +
            "  <div class='current' style='display:none'></div>" +
            "  <div class='next' style='display:none'></div>" +
            "</td>" +
            "</tr></table>");

          $('#times').prepend(table);

          var updateDisplay = function() {
            getTimes(data, function(times) {
              table.find('*[class=loading]').hide();

              var current = table.find('*[class=current]');
              if(times.length > 0) {
                current.text(times.shift());
              } else current.text('None');
              current.show();

              table.find('*[class=next]').text(times.join(', ')).show();
            });
          };
          updateDisplay();
          setInterval(updateDisplay, 30000);
        }

        var getTimes = function(data, callback) {
          var firstCol = []
          $.each(data, function(i, p) { firstCol.push(p[0]); });
          
          var u = url(firstCol);
          $.getJSON(u, callback);
        }

        var time = function() {
          save(selects);
          displayCookie(0);
        };

        var displayCookie = function(c_name) {
          var c = cookie(c_name);
          if(!c) return;
          var d = unstringify(c);
          display(d);
        };
        for(var i = cookies - 1; i >= 0; i--)
          displayCookie(i);

        // iphone orientation html
        var orientation = null;
        var orient = function() {
          var current_orientation = (window.innerWidth == 320 ? 'portrait' : 'landscape');
          if(orientation != current_orientation) {
            orientation = current_orientation;
            $('body').attr({ orient: orientation });
            setTimeout(scrollTo, 100, 0, 1);
          }
        }
        setInterval(orient, 500);

      });
    });
  </script>
</head>
<body>
<h1>munistop</h1>
<div id="times"></div>
<form>
  <select name="routes"><option>Route</option></select>
  <select name="directions"><option>Direction</option></select>
  <select name="stops"><option>Stop</option></select>
</form>
</body>
</html>
